name: PR Auto-merge with Token (Alternative)

on:
  workflow_run:
    workflows: ["PR Metadata Validation"]
    types:
      - completed

permissions:
  contents: write
  pull-requests: write
  actions: read

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'
    steps:
      - name: Get PR number
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pulls } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${context.payload.workflow_run.head_branch}`,
              state: 'open'
            });

            if (pulls.length === 0) {
              console.log('No open PR found for this branch');
              return;
            }

            const pr = pulls[0];
            console.log(`Found PR #${pr.number}: ${pr.title}`);

            // PR ì œëª©ì´ agenda í˜•ì‹ì¸ì§€ í™•ì¸
            if (!pr.title.match(/^\[Agenda( Update)?\] (mainnet|sepolia) - [0-9]+ - .+/)) {
              console.log('PR title does not match agenda format, skipping auto-merge');
              return;
            }

            return pr.number;

      - name: Auto-merge PR
        if: steps.pr.outputs.result
        uses: actions/github-script@v7
        with:
          # Personal Access Token ì‚¬ìš© (ì„ íƒì‚¬í•­)
          # github-token: ${{ secrets.PAT_TOKEN }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = ${{ steps.pr.outputs.result }};

            console.log(`ğŸš€ Attempting to auto-merge PR #${prNumber}...`);

            try {
              // PR ì •ë³´ ê°€ì ¸ì˜¤ê¸°
              const { data: pr } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber
              });

              // ìë™ ë¨¸ì§€ ì‹œë„
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                commit_title: "Auto-merge: " + pr.title,
                commit_message: "âœ… All validations passed - Auto-merged by workflow\n\n" +
                               "This PR was automatically merged after successful validation.",
                merge_method: "squash"
              });

              console.log("âœ… PR successfully auto-merged!");

              // ì„±ê³µ ëŒ“ê¸€ ì¶”ê°€
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: "ğŸ‰ **Auto-merge successful!**\n\n" +
                      "This PR has been automatically merged after passing all validations.\n\n" +
                      "Thank you for your contribution! ğŸš€"
              });

            } catch (error) {
              console.log("âš ï¸ Auto-merge failed:", error.message);

              // ì‹¤íŒ¨ ëŒ“ê¸€ ì¶”ê°€
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: "âš ï¸ **Auto-merge failed**\n\n" +
                      `**Reason**: ${error.message}\n\n` +
                      "âœ… All validations passed - The PR is ready for manual merge!"
              });
            }