name: Auto Merge

on:
  workflow_run:
    workflows: ["PR Metadata Validation"]
    types:
      - completed

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.event == 'pull_request'
    steps:
            - name: Get PR number
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            console.log('=== Workflow Run Event Debug ===');
            console.log('Event name:', context.eventName);
            console.log('Action:', context.payload.action);
            console.log('Workflow run ID:', context.payload.workflow_run?.id);
            console.log('Head branch:', context.payload.workflow_run?.head_branch);
            console.log('Head SHA:', context.payload.workflow_run?.head_sha);
            console.log('Repository:', context.payload.workflow_run?.head_repository?.full_name);

            // workflow_runì—ì„œ PR ì •ë³´ ì§ì ‘ ê°€ì ¸ì˜¤ê¸°
            const workflowRun = context.payload.workflow_run;

            if (!workflowRun) {
              console.log('âŒ No workflow_run data available');
              return null;
            }

            // PR ë¦¬ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
            const { data: pulls } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open'
            });

            console.log(`ğŸ“‹ Found ${pulls.length} open PRs`);

            // ëª¨ë“  PR ì •ë³´ ë¡œê¹…
            for (const pr of pulls) {
              console.log(`PR #${pr.number}: "${pr.title}"`);
              console.log(`  - Head ref: ${pr.head.ref}`);
              console.log(`  - Head SHA: ${pr.head.sha}`);
              console.log(`  - Base ref: ${pr.base.ref}`);
            }

            // ì—¬ëŸ¬ ì¡°ê±´ìœ¼ë¡œ PR ì°¾ê¸°
            let matchingPr = null;

            // 1. SHAë¡œ ë¨¼ì € ì°¾ê¸°
            matchingPr = pulls.find(pr => pr.head.sha === workflowRun.head_sha);
            if (matchingPr) {
              console.log(`âœ… Found PR by SHA: #${matchingPr.number}`);
            }

            // 2. ë¸Œëœì¹˜ëª…ìœ¼ë¡œ ì°¾ê¸°
            if (!matchingPr) {
              matchingPr = pulls.find(pr => pr.head.ref === workflowRun.head_branch);
              if (matchingPr) {
                console.log(`âœ… Found PR by branch: #${matchingPr.number}`);
              }
            }

            // 3. ë¶€ë¶„ ë¸Œëœì¹˜ëª… ë§¤ì¹­ (agenda-XXX íŒ¨í„´)
            if (!matchingPr && workflowRun.head_branch) {
              matchingPr = pulls.find(pr =>
                pr.head.ref.includes(workflowRun.head_branch) ||
                workflowRun.head_branch.includes(pr.head.ref)
              );
              if (matchingPr) {
                console.log(`âœ… Found PR by partial branch match: #${matchingPr.number}`);
              }
            }

            if (!matchingPr) {
              console.log('âŒ No matching PR found');
              console.log('Available PRs:', pulls.map(pr => `#${pr.number} (${pr.head.ref})`));
              return null;
            }

            console.log(`ğŸ¯ Final match: PR #${matchingPr.number}: "${matchingPr.title}"`);

            // Agenda PRì¸ì§€ í™•ì¸
            if (!matchingPr.title.match(/^\[Agenda( Update)?\] (mainnet|sepolia) - [0-9]+ - .+/)) {
              console.log('âš ï¸ PR title does not match agenda format, skipping auto-merge');
              console.log('Expected format: [Agenda] <network> - <id> - <title>');
              return null;
            }

            console.log('âœ… PR title matches agenda format');
            return matchingPr.number;

      - name: Auto-merge PR
        if: steps.pr.outputs.result != 'null'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.pr.outputs.result }};

            if (!prNumber) {
              console.log('No PR to merge');
              return;
            }

            console.log(`ğŸš€ Auto-merging PR #${prNumber}...`);

            try {
              // PR ìƒíƒœ í™•ì¸
              const { data: pr } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber
              });

              if (pr.state !== 'open') {
                console.log(`PR #${prNumber} is not open (state: ${pr.state})`);
                return;
              }

              if (pr.draft) {
                console.log(`PR #${prNumber} is in draft state`);
                return;
              }

              // ìë™ ë¨¸ì§€ ì‹œë„
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                commit_title: `Auto-merge: ${pr.title}`,
                commit_message: `âœ… Auto-merged after successful validation\n\nAll checks passed:\n- Schema validation\n- Format validation\n- PR title validation\n- Time validation\n- Signature validation\n- Transaction validation`,
                merge_method: "squash"
              });

              console.log(`âœ… PR #${prNumber} successfully auto-merged!`);

              // ì„±ê³µ ëŒ“ê¸€
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `ğŸ‰ **Auto-merge successful!**\n\nThis PR has been automatically merged after all validations passed.\n\nâœ… All checks completed successfully\n\nThank you for your contribution! ğŸš€`
              });

            } catch (error) {
              console.log(`âŒ Auto-merge failed: ${error.message}`);

              // ì‹¤íŒ¨ ëŒ“ê¸€
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `âš ï¸ **Auto-merge failed**\n\n**Reason**: ${error.message}\n\nâœ… **All validations passed** - The PR is ready for manual merge!\n\nPlease merge manually when ready.`
              });
            }